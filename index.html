<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Royal Phantom - Premium Fashion</title>
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #d4af37; /* Gold */
            --secondary: #1a1a1a; /* Black */
            --bg-color: #f4f4f4;
            --white: #ffffff;
            --shadow-card: 0 10px 25px rgba(0,0,0,0.08);
            --success: #28a745;
            --discount-red: #e74c3c;
            --season-color: #5d6d7e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #e0e0e0; display: flex; justify-content: center; min-height: 100vh; overflow: hidden; }
        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }

        .app-container {
            width: 100%; max-width: 480px; background: var(--bg-color); position: relative;
            min-height: 100vh; overflow-x: hidden; padding-bottom: 90px; box-shadow: 0 0 20px rgba(0,0,0,0.1);
            opacity: 0; transition: opacity 1s ease;
        }

        /* --- INTRO & SUCCESS ANIMATION STYLES --- */
        #intro-overlay, #success-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        
        #success-overlay { z-index: 6000; display: none; }

        .intro-welcome, .success-msg {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem; letter-spacing: 3px; color: #fff;
            opacity: 0; transform: translateY(20px);
            margin-bottom: 20px;
        }

        .intro-brand, .success-user-name {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem; line-height: 1.2;
            color: var(--primary);
            font-weight: 700;
            display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;
            margin-bottom: 15px; perspective: 1000px;
        }
        
        .brand-char { display: inline-block; opacity: 0; transform-origin: center; filter: blur(10px); }
        .intro-tagline {
            font-family: 'Playfair Display', serif; font-size: 1rem; color: #888; font-style: italic;
            border-top: 1px solid #333; border-bottom: 1px solid #333; padding: 10px 0; width: 0; white-space: nowrap; overflow: hidden; opacity: 0; margin-top: 20px;
        }

        /* Animations */
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes assemble {
            0% { opacity: 0; transform: translate(var(--rx), var(--ry)) rotate(var(--rr)) scale(2); filter: blur(10px); }
            60% { opacity: 1; transform: translate(0, 0) rotate(0) scale(1); filter: blur(0); }
            100% { opacity: 1; transform: translate(0, 0) rotate(0) scale(1); filter: blur(0); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        }
        @keyframes expandLine { 0% { width: 0; opacity: 0; } 50% { opacity: 1; } 100% { width: 80%; opacity: 1; } }
        @keyframes curtainExit { to { transform: translateY(-100%); opacity: 0; pointer-events: none; } }

        /* --- PROMO POPUP --- */
        #promo-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 4500; display: none; justify-content: center; align-items: center; animation: fadeIn 0.5s ease;
        }
        .promo-content {
            background: white; width: 85%; max-width: 350px; border-radius: 15px; padding: 20px; position: relative;
            text-align: center; box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); border: 2px solid var(--primary);
        }
        .promo-close {
            position: absolute; top: -15px; right: -15px; background: var(--secondary); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 2px solid var(--white); font-weight: bold; font-size: 1.2rem;
        }
        .promo-img { width: 100%; border-radius: 10px; margin-bottom: 10px; object-fit: cover; max-height: 250px; display: none; }
        .promo-text { color: var(--secondary); font-size: 1rem; margin-bottom: 10px; font-weight: 600; display: none; }

        /* --- COMPONENTS --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 45px; height: 45px; animation: spin 0.8s ease-in-out infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Screens */
        .screen { display: none; padding: 15px; animation: fadeIn 0.4s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--white); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }
        .header h2 { color: var(--secondary); font-weight: 700; font-size: 1.4rem; }

        /* Gender Filter */
        .gender-filter-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .gender-btn {
            background: white; border: 1px solid #ccc; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.3s; color: #555;
        }
        .gender-btn.active { background: var(--secondary); color: var(--primary); border-color: var(--secondary); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Product Grid */
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 20px; }
        .product-card { 
            background: white; border-radius: 12px; box-shadow: var(--shadow-card); cursor: pointer; transition: 0.3s; overflow: hidden; position: relative;
        }
        .p-img-container { width: 100%; height: 190px; background: #eee; overflow: hidden; position: relative; }
        .p-img-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .discount-badge {
            position: absolute; top: 10px; right: 10px; background: var(--discount-red); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; z-index: 2;
        }
        .gender-tag-card {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 500; z-index: 2; text-transform: uppercase;
        }

        .p-details { padding: 12px; }
        .p-name { font-weight: 600; color: #333; margin-bottom: 2px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-season { font-size: 0.7rem; color: var(--season-color); margin-bottom: 5px; font-style: italic; display: flex; align-items: center; gap: 4px;}
        .p-price-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .p-price { font-weight: 700; color: var(--secondary); font-size: 1rem; }
        .p-old-price { text-decoration: line-through; color: #999; font-size: 0.85rem; }

        /* Buttons & Forms */
        .btn-main { 
            width: 100%; background: var(--secondary); color: var(--primary); padding: 16px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 15px; box-shadow: 0 8px 15px rgba(0,0,0,0.2); transition: 0.3s; text-transform: uppercase;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-gold { background: var(--primary); color: white; }
        .form-control { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; background: #fff; margin-bottom: 12px; outline:none;}

        /* Payment Grid */
        .payment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .payment-option {
            background: white; border: 2px solid #eee; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; opacity: 0.8;
        }
        .payment-option img { height: 40px; object-fit: contain; margin-bottom: 8px; }
        .payment-option span { font-size: 0.8rem; font-weight: 600; color: #555; }
        .payment-option.active { border-color: var(--primary); background: #fffbe6; opacity: 1; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2); }

        /* Media Slider */
        .media-slider-container { width: 100%; height: 380px; position: relative; background: #000; border-radius: 15px; overflow: hidden; margin-bottom: 15px; }
        .media-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; width: 100%; height: 100%; scroll-behavior: smooth; }
        .media-slider::-webkit-scrollbar { display: none; }
        .media-slide { min-width: 100%; height: 100%; scroll-snap-align: center; position: relative; display: flex; align-items: center; justify-content: center; }
        .media-slide img, .media-slide video { width: 100%; height: 100%; object-fit: contain; }
        .zoom-hint { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; pointer-events: none; }
        
        #zoom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 4000; justify-content: center; align-items: center; }
        #zoom-img { max-width: 100%; max-height: 100%; object-fit: contain; transform: scale(1); transition: transform 0.3s; }
        .zoom-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer; z-index: 4001; }

        /* Product Details Info */
        .pd-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .pd-title-side { width: 65%; display: flex; align-items: flex-start; flex-direction: column; }
        .pd-price-side { width: 35%; text-align: right; }
        .pd-title { font-size: 1.3rem; color: var(--secondary); line-height: 1.2; margin-bottom: 5px; }
        .share-btn-icon { font-size: 1.2rem; color: var(--primary); cursor: pointer; padding: 5px; transition: transform 0.2s; margin-top: 5px; }
        .pd-final-price { font-size: 1.5rem; color: var(--primary); font-weight: 700; display: block; }
        .pd-old-price { font-size: 1rem; color: #999; text-decoration: line-through; display: block; margin-bottom: 2px;}
        .pd-discount-tag { font-size: 0.8rem; color: var(--discount-red); font-weight: 600; background: #ffebeb; padding: 2px 6px; border-radius: 4px; display: inline-block; }

        /* Invoice & Social */
        .invoice-card { background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow-card); border-top: 5px solid var(--secondary); }
        .inv-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .inv-row:last-child { border: none; margin-bottom: 0; }
        .inv-label { font-weight: 600; color: #666; }
        .inv-val { font-weight: 600; color: #333; text-align: right; width: 60%; }

        .social-row { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .social-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; transition: 0.3s; text-decoration: none; }
        .sb-wa { background: #25D366; } .sb-tg { background: #0088cc; } .sb-imo { background: #0056b3; }
        .select-btn { border: 1px solid #ddd; background: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-right: 5px; display: inline-block; margin-bottom: 5px; }
        .select-btn.active { background: var(--secondary); color: var(--primary); border-color: var(--secondary); }

        /* Dropshipping & Search */
        .ds-balance-card { background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: var(--primary); padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
        .ds-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ds-card { background: white; padding: 15px; border-radius: 12px; box-shadow: var(--shadow-card); text-align: center; }
        
        .search-mode-container { display: flex; background: #fff; padding: 5px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); gap: 5px; }
        .mode-btn { flex: 1; padding: 10px 5px; border: none; background: transparent; color: #777; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 0.85rem; display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .mode-btn.active { background: var(--secondary); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .category-scroll { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0; justify-content: center; }
        .cat-btn { background: white; border: 1px solid #ddd; padding: 10px 20px; border-radius: 20px; white-space: nowrap; font-size: 0.9rem; color: #555; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .cat-btn.active { background: var(--secondary); color: var(--primary); border-color: var(--secondary); font-weight: 600; }

        /* Campaign */
        .campaign-list-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #eee; }
        .rank-1 { border-left-color: #FFD700; background: #fffbe6; } .rank-2 { border-left-color: #C0C0C0; } .rank-3 { border-left-color: #CD7F32; }
        .rank-badge { width: 30px; height: 30px; border-radius: 50%; background: #333; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 10px; }
        .rank-1 .rank-badge { background: #FFD700; color: #333; }
        
        /* LUCKY GAME STYLES */
        .game-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 320px; margin: 20px auto;
        }
        .game-box {
            background: #222; border-radius: 10px; height: 80px; display: flex; align-items: center; justify-content: center;
            color: #d4af37; font-size: 1.5rem; font-weight: bold; cursor: pointer; border: 2px solid #444; transition: 0.2s;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .game-box.highlight { background: #d4af37; color: #000; transform: scale(1.05); box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); border-color: #fff; }
        .game-btn { background: #d4af37; color: #000; padding: 15px 40px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; border: none; cursor: pointer; box-shadow: 0 5px 15px rgba(212,175,55,0.4); animation: pulseBtn 2s infinite; }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .discount-active-banner {
            background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; max-width: 480px; background: white; 
            display: flex; justify-content: space-around; padding: 12px 0; border-radius: 20px 20px 0 0; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 500;
        }
        .nav-item { text-align: center; color: #ccc; cursor: pointer; }
        .nav-item.active { color: var(--secondary); }

    </style>
</head>
<body>

<!-- ZOOM MODAL -->
<div id="zoom-modal" onclick="this.style.display='none'">
    <span class="zoom-close">&times;</span>
    <img id="zoom-img" src="">
</div>

<!-- PROMO POPUP -->
<div id="promo-modal">
    <div class="promo-content">
        <div class="promo-close" onclick="document.getElementById('promo-modal').style.display='none'">&times;</div>
        <img id="promo-img" class="promo-img" src="">
        <h3 id="promo-text" class="promo-text"></h3>
    </div>
</div>

<!-- INTRO ANIMATION -->
<div id="intro-overlay">
    <div id="intro-welcome" class="intro-welcome">WELCOME</div>
    <div id="intro-brand" class="intro-brand"></div>
    <div id="intro-tagline" class="intro-tagline">Premium Fashion & Royal Lifestyle</div>
</div>

<!-- SUCCESS ANIMATION -->
<div id="success-overlay">
    <div id="succ-msg-1" class="success-msg">Order Placed Successfully!</div>
    <div id="succ-msg-2" class="success-msg" style="font-size:1rem; color:#ccc;">Thank You</div>
    <div id="succ-user-name" class="success-user-name"></div>
    <div style="margin-top:40px; color:#d4af37; font-size:2rem;"><i class="fas fa-check-circle"></i></div>
</div>

<!-- Loader -->
<div id="loader"><div class="spinner"></div></div>

<!-- Contact Modal -->
<div id="contact-modal" onclick="if(event.target === this) this.style.display='none'" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3000; justify-content:center; align-items:center; backdrop-filter: blur(5px);">
    <div style="background:white; padding:30px; border-radius:20px; width:85%; max-width:320px; text-align:center;">
        <h3 style="color:var(--secondary); margin-bottom:10px;">Contact Support</h3>
        <p style="color:#777; margin-bottom:20px;">We are available 24/7</p>
        <div class="social-row">
            <a href="https://wa.me/+8801338747464" class="social-btn sb-wa"><i class="fab fa-whatsapp"></i></a>
            <a href="https://t.me/+8801338747464" class="social-btn sb-tg"><i class="fab fa-telegram-plane"></i></a>
            <a href="tel:01338747464" class="social-btn sb-imo" onclick="alert('Add 01338747464 on IMO')"><i class="fas fa-comment"></i></a>
        </div>
        <p style="margin-top:15px; font-weight:600;">01338747464</p>
        <button onclick="document.getElementById('contact-modal').style.display='none'" style="margin-top:20px; background:transparent; border:none; color:#999; cursor:pointer;">Close</button>
    </div>
</div>

<div id="main-app" class="app-container">
    
    <!-- Header -->
    <div class="header">
        <h2 id="page-title">Royal Phantom</h2>
        <div onclick="window.app.openOrders()" style="cursor:pointer;">
            <i class="fas fa-shopping-bag" style="font-size:1.3rem; color:var(--secondary);"></i>
        </div>
    </div>

    <!-- 1. HOME -->
    <div id="home-screen" class="screen active">
        <div id="dynamic-banner" style="width:100%; height:200px; background-color:#333; border-radius:15px; margin-bottom:20px; position:relative; overflow:hidden;">
            <img id="banner-img" src="https://images.unsplash.com/photo-1441986300917-64674bd600d8?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" style="width:100%; height:100%; object-fit:cover; position:absolute; inset:0;">
            <div style="background:linear-gradient(to right, rgba(0,0,0,0.8), rgba(0,0,0,0.1)); position:absolute; inset:0;"></div>
            <div style="position:relative; color:white; z-index:2; height:100%; display:flex; flex-direction:column; justify-content:center; padding:20px;">
                <h4 id="banner-sub" style="color:#d4af37; letter-spacing:2px; font-weight:400; font-size:0.9rem; text-transform:uppercase;">New Collection</h4>
                <h1 id="banner-title" style="font-size:2rem; line-height:1.1; font-family:'Playfair Display', serif;">Royal<br>Arrivals</h1>
            </div>
        </div>

        <div class="gender-filter-container">
            <button class="gender-btn active" id="btn-gen-all" onclick="window.app.filterGender('all')">All</button>
            <button class="gender-btn" id="btn-gen-men" onclick="window.app.filterGender('Men')"><i class="fas fa-male"></i> Men</button>
            <button class="gender-btn" id="btn-gen-women" onclick="window.app.filterGender('Women')"><i class="fas fa-female"></i> Women</button>
        </div>

        <div id="product-grid" class="product-grid"></div>
    </div>

    <!-- 2. SEARCH -->
    <div id="search-screen" class="screen">
        <div style="position: sticky; top:0; background:var(--bg-color); z-index:10; padding-bottom:5px;">
            <div class="search-mode-container">
                <button id="btn-mode-name" class="mode-btn active" onclick="window.app.toggleSearchMode('name')"><i class="fas fa-list"></i> লিস্ট</button>
                <button id="btn-mode-cat" class="mode-btn" onclick="window.app.toggleSearchMode('category')"><i class="fas fa-th-large"></i> ক্যাটাগরি</button>
                <button id="btn-mode-season" class="mode-btn" onclick="window.app.toggleSearchMode('season')"><i class="fas fa-cloud-sun-rain"></i> সিজন</button>
            </div>
            <div id="search-input-container">
                <input type="text" id="search-input" class="form-control" placeholder="নাম, ক্যাটাগরি বা কোড (ID) লিখুন..." onkeyup="window.app.searchProduct(this.value)">
            </div>
            <div id="category-container" style="display:none; animation:fadeIn 0.3s;">
                <div id="category-filters" class="category-scroll"></div>
            </div>
            <div id="season-container" style="display:none; animation:fadeIn 0.3s;">
                <div id="season-filters" class="category-scroll"></div>
            </div>
        </div>
        <div id="search-results" class="product-grid" style="margin-top:10px;"></div>
    </div>

    <!-- 3. PROFILE -->
    <div id="profile-screen" class="screen">
        <div style="text-align:center; margin:30px 0;">
            <div style="width:100px; height:100px; background:#ddd; border-radius:50%; margin:0 auto 15px; overflow:hidden; border:3px solid var(--secondary);">
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <h3 id="user-name">Guest User</h3>
        </div>
        <div style="background:white; border-radius:15px; overflow:hidden; box-shadow:var(--shadow-card);">
            <div onclick="window.app.openCampaign()" style="padding:20px; border-bottom:1px solid #eee; display:flex; align-items:center; cursor:pointer;">
                <i class="fas fa-trophy" style="width:30px; color:#FFD700;"></i> Top Buyers List
            </div>
            <!-- DISCOUNT BUTTON -->
            <div id="btn-discount-feature" onclick="window.app.startLuckyGame()" style="padding:20px; border-bottom:1px solid #eee; display:flex; align-items:center; cursor:pointer; background:#f9f9f9; opacity:0.6; pointer-events:none;">
                <i class="fas fa-gift" style="width:30px; color:#e74c3c;"></i> Claim Lucky Discount
                <small id="discount-status" style="margin-left:auto; font-size:0.7rem; color:#888;">(Need 5k Spent)</small>
            </div>

            <div onclick="window.app.openOrders()" style="padding:20px; border-bottom:1px solid #eee; display:flex; align-items:center; cursor:pointer;">
                <i class="fas fa-box" style="width:30px; color:var(--primary);"></i> My Orders
            </div>
            <div onclick="window.ds.checkAuth()" style="padding:20px; border-bottom:1px solid #eee; display:flex; align-items:center; cursor:pointer; border-left: 5px solid var(--primary);">
                <i class="fas fa-hand-holding-usd" style="width:30px; color:var(--primary);"></i> Dropshipping Portal
            </div>
            <div onclick="document.getElementById('contact-modal').style.display='flex'" style="padding:20px; display:flex; align-items:center; cursor:pointer;">
                <i class="fas fa-headset" style="width:30px; color:var(--primary);"></i> Help Center
            </div>
        </div>
    </div>

    <!-- NEW SCREEN: LUCKY GAME -->
    <div id="game-screen" class="screen" style="background:#111; color:white; min-height:100vh;">
        <div onclick="window.app.navTo('profile-screen')" style="margin-bottom:20px; cursor:pointer; color:var(--primary);"><i class="fas fa-arrow-left"></i> Back</div>
        <div style="text-align:center;">
            <h2 style="color:var(--primary); font-family:'Cinzel', serif;">Royal Luck</h2>
            <p style="color:#888; margin-bottom:20px;">Spin to win a discount!</p>
            
            <div class="game-grid">
                <div class="game-box" id="box-1">?</div>
                <div class="game-box" id="box-2">?</div>
                <div class="game-box" id="box-3">?</div>
                <div class="game-box" id="box-4">?</div>
                <div class="game-box" id="box-5">?</div>
                <div class="game-box" id="box-6">?</div>
                <div class="game-box" id="box-7">?</div>
                <div class="game-box" id="box-8">?</div>
                <div class="game-box" id="box-9">?</div>
            </div>

            <button class="game-btn" onclick="window.game.spin()" id="spin-btn">SPIN NOW</button>
            <p style="margin-top:20px; font-size:0.8rem; color:#555;">*Discount applicable on products <= 3000 TK</p>
        </div>
    </div>

    <!-- CAMPAIGN SCREEN -->
    <div id="campaign-screen" class="screen">
        <div onclick="window.app.navTo('profile-screen')" style="margin-bottom:20px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Back</div>
        <div style="text-align:center; margin-bottom:20px;">
            <i class="fas fa-crown" style="font-size:3rem; color:#FFD700; margin-bottom:10px;"></i>
            <h2>Top Buyers</h2>
            <p style="color:#777;">Customers with highest purchase amount</p>
        </div>
        <div id="campaign-list"><div style="text-align:center;"><div class="spinner"></div></div></div>
    </div>

    <!-- ORDERS SCREEN -->
    <div id="orders-screen" class="screen">
        <div onclick="window.history.back()" style="margin-bottom:20px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Back</div>
        <h2>My Orders</h2>
        <div id="order-list-container" style="margin-top:20px;"></div>
    </div>

    <!-- PRODUCT DETAILS -->
    <div id="product-details-screen" class="screen">
        <div onclick="window.app.navTo('home-screen')" style="margin-bottom:15px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Back</div>
        
        <div class="media-slider-container">
            <div id="pd-slider" class="media-slider"></div>
            <div class="zoom-hint"><i class="fas fa-search-plus"></i> Tap to Zoom</div>
        </div>
        
        <div class="pd-header-row">
            <div class="pd-title-side">
                <h2 id="pd-title" class="pd-title">Product Name</h2>
                <div id="pd-season-tag" style="font-size:0.9rem; color:#666; font-style:italic; margin-bottom:5px;"></div>
                <div id="pd-gender-tag" style="font-size:0.8rem; background:var(--secondary); color:white; display:inline-block; padding:2px 8px; border-radius:4px;"></div>
                <i onclick="window.app.shareCurrentProduct()" class="fas fa-share-alt share-btn-icon" title="Share Product"></i>
            </div>
            <div class="pd-price-side">
                <span id="pd-old-price" class="pd-old-price"></span>
                <span id="pd-price" class="pd-final-price">৳0</span>
                <span id="pd-discount-tag" class="pd-discount-tag" style="display:none;"></span>
                <div id="lucky-msg" style="display:none; font-size:0.7rem; color:red; font-weight:bold; margin-top:5px;"></div>
            </div>
        </div>

        <div style="padding-bottom:20px;">
            <p id="pd-desc" style="color:#666; margin-bottom:20px; line-height: 1.6;">Description...</p>
            <span style="font-weight:600; display:block; margin-bottom:5px;">Size</span>
            <div id="size-container" style="margin-bottom:15px;"></div>
            <span style="font-weight:600; display:block; margin-bottom:5px;">Color</span>
            <div id="color-container" style="margin-bottom:20px;"></div>
            <button class="btn-main" onclick="window.app.startCheckout()">BUY NOW</button>
            <button id="btn-ds-add" class="btn-main btn-gold" style="display:none; margin-top:10px;" onclick="window.ds.placeDropshipOrder()">PLACE DROPSHIP ORDER</button>
        </div>
    </div>

    <!-- CHECKOUT -->
    <div id="checkout-screen" class="screen">
        <div onclick="window.app.navTo('product-details-screen')" style="margin-bottom:20px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Checkout Details</div>
        
        <div id="discount-active-msg" class="discount-active-banner" style="display:none;">
            <i class="fas fa-check-circle"></i> <span id="co-disc-txt">Discount Applied!</span>
        </div>

        <div style="background:#fffbe6; padding:15px; border-radius:10px; margin-bottom:15px; border:1px dashed #d4af37;">
            <span style="font-size:0.8rem; font-weight:600;">Referral Code (Optional)</span>
            <input type="text" id="co-ref" class="form-control" placeholder="Enter Ref Code" style="margin-bottom:0; margin-top:5px;">
        </div>

        <input type="text" id="co-name" class="form-control" placeholder="Full Name">
        <input type="tel" id="co-phone" class="form-control" placeholder="Phone Number">
        <textarea id="co-address" class="form-control" placeholder="Full Address (House, Road, Area, City)" rows="3"></textarea>
        
        <h4 style="margin:15px 0 10px;">Select Payment Method</h4>
        <input type="hidden" id="co-payment" value="">

        <div class="payment-grid">
            <div class="payment-option" onclick="window.app.selectPayment('bkash', this)">
                <img src="https://i.ibb.co/5LhqdPQ/bkash.png" alt="bKash"> <span>bKash</span>
            </div>
            <div class="payment-option" onclick="window.app.selectPayment('nagad', this)">
                <img src="https://i.ibb.co/7Nkqj35/nagad.png" alt="Nagad"> <span>Nagad</span>
            </div>
            <div class="payment-option" onclick="window.app.selectPayment('rocket', this)">
                <img src="https://i.ibb.co/9nKKg3p/rocket.png" alt="Rocket"> <span>Rocket</span>
            </div>
            <div class="payment-option" onclick="window.app.selectPayment('cod', this)">
                <i class="fas fa-hand-holding-usd" style="font-size:35px; color:#333; margin-bottom:8px;"></i> <span>Cash on Delivery</span>
            </div>
        </div>
        
        <div id="trx-box" style="display:none; animation:fadeIn 0.5s;">
            <div style="background:#e8f0fe; padding:10px; border-radius:8px; border:1px solid #b3d7ff; margin-bottom:10px;">
                <p style="font-size:0.85rem; color:#004085; margin-bottom:5px;">Send Money (Personal) to:</p>
                <b style="font-size:1.2rem; color:#0056b3;">01338747464</b>
                <p id="pay-amount-hint" style="color:#d4af37; font-weight:bold; margin-top:5px;">Amount: ৳0</p>
            </div>
            <input type="text" id="co-trx" class="form-control" placeholder="Enter Transaction ID" style="border:2px solid var(--primary);">
        </div>

        <button class="btn-main" onclick="window.app.showReview()">PROCEED TO REVIEW</button>
    </div>

    <!-- REVIEW -->
    <div id="review-screen" class="screen">
        <div onclick="window.app.navTo('checkout-screen')" style="margin-bottom:20px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Edit Details</div>
        <div style="text-align:center; margin-bottom:15px;">
            <h2 style="color:var(--secondary);">Order Summary</h2>
            <p style="color:#777; font-size:0.9rem;">Please review your order details</p>
        </div>
        <div class="invoice-card" id="invoice-content"></div>
        <button class="btn-main" onclick="window.app.finalizeOrder()">CONFIRM & PLACE ORDER</button>
    </div>

    <!-- DROPSHIPPING SCREENS -->
    <div id="ds-login-screen" class="screen">
        <div onclick="window.app.navTo('profile-screen')" style="margin-bottom:20px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Back</div>
        <div style="text-align:center; margin-bottom:30px;">
            <i class="fas fa-crown" style="font-size:3rem; color:var(--primary);"></i>
            <h2>Dropshipper Login</h2>
        </div>
        <input type="tel" id="ds-login-phone" class="form-control" placeholder="Phone Number">
        <input type="password" id="ds-login-pass" class="form-control" placeholder="Password">
        <button class="btn-main" onclick="window.ds.login()">LOGIN</button>
        <p style="text-align:center; margin-top:20px;">
            No account? <span onclick="window.app.navTo('ds-register-screen')" style="color:var(--primary); font-weight:600; cursor:pointer;">Register</span>
        </p>
    </div>

    <div id="ds-register-screen" class="screen">
        <div onclick="window.app.navTo('ds-login-screen')" style="margin-bottom:20px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Login</div>
        <h2>Join as Dropshipper</h2>
        <input type="text" id="ds-reg-email" class="form-control" placeholder="Email Address">
        <input type="tel" id="ds-reg-phone" class="form-control" placeholder="Phone Number">
        <input type="password" id="ds-reg-pass" class="form-control" placeholder="Password">
        <input type="password" id="ds-reg-confirm" class="form-control" placeholder="Confirm Password">
        <button class="btn-main" onclick="window.ds.register()">CREATE ACCOUNT</button>
    </div>

    <div id="ds-dashboard-screen" class="screen">
        <div class="header" style="position:static; padding:0; box-shadow:none; margin-bottom:20px;">
            <div onclick="window.app.navTo('profile-screen')" style="cursor:pointer;"><i class="fas fa-arrow-left"></i> Exit</div>
            <h3 style="color:var(--primary);">Dashboard</h3>
            <div onclick="window.ds.logout()" style="cursor:pointer; font-size:0.9rem; color:red;">Logout</div>
        </div>
        <div class="ds-balance-card">
            <span>Total Balance</span>
            <h1 id="ds-balance">৳0</h1>
            <button onclick="window.app.navTo('ds-withdraw-screen')" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.5); color:white; padding:5px 15px; border-radius:20px; cursor:pointer;">Withdraw</button>
        </div>
        <div style="background:#fffbe6; border:1px dashed var(--primary); padding:10px; border-radius:8px; text-align:center; margin-bottom:20px;">
            <span>Ref Code: </span><b id="ds-ref-code">...</b> <small onclick="window.ds.copyRef()">(Copy)</small>
        </div>
        <div class="ds-stat-grid">
            <div class="ds-card"><h3 id="ds-sales">0</h3><p>Sales</p></div>
            <div class="ds-card"><h3 id="ds-sold-amt">৳0</h3><p>Sold</p></div>
            <div class="ds-card"><h3 id="ds-completed" style="color:green;">0</h3><p>Done</p></div>
            <div class="ds-card"><h3 id="ds-cancelled" style="color:red;">0</h3><p>Cancel</p></div>
        </div>
        <h3 style="margin:20px 0 10px;">Products</h3>
        <div class="product-grid" id="ds-product-grid"></div>
    </div>

    <div id="ds-withdraw-screen" class="screen">
        <div onclick="window.app.navTo('ds-dashboard-screen')" style="margin-bottom:20px; cursor:pointer;"><i class="fas fa-arrow-left"></i> Back</div>
        <h2>Withdraw Funds</h2>
        <select id="w-method" class="form-control">
            <option value="bkash">bKash</option>
            <option value="nagad">Nagad</option>
        </select>
        <input type="tel" id="w-number" class="form-control" placeholder="Account Number">
        <input type="number" id="w-amount" class="form-control" placeholder="Amount (min 500)">
        <button class="btn-main" onclick="window.ds.submitWithdraw()">SUBMIT REQUEST</button>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="window.app.navTo('home-screen', this)"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="window.app.navTo('search-screen', this)"><i class="fas fa-search"></i></div>
        <div class="nav-item" onclick="window.app.navTo('profile-screen', this)"><i class="fas fa-user"></i></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDhdr92wBIWGowF4_YQuZJ1NcHAJO7gkBE",
        authDomain: "e-comarce-9ec9f.firebaseapp.com",
        databaseURL: "https://e-comarce-9ec9f-default-rtdb.firebaseio.com",
        projectId: "e-comarce-9ec9f",
        storageBucket: "e-comarce-9ec9f.firebasestorage.app",
        messagingSenderId: "429520181562",
        appId: "1:429520181562:web:c0660534faf74294ee1803",
        measurementId: "G-MKK5GK1TDP"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    // --- STATE ---
    window.products = [];
    window.currentProduct = null;
    window.selectedSize = '';
    window.selectedColor = '';
    window.isDropshippingMode = false;
    window.pendingOrder = null;
    window.currentDsBalance = 0; 
    window.activeGender = 'all'; 
    window.wonDiscountPercent = 0; // NEW: Holds the won discount percentage

    // --- APP LOGIC ---
    window.app = {
        navTo: (id, navEl) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
            if(navEl) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                navEl.classList.add('active');
            }
            if(id === 'profile-screen') window.app.checkDiscountEligibility();
        },

        checkUserSession: () => {
            const name = localStorage.getItem('rp_user_name');
            const phone = localStorage.getItem('rp_user_phone');
            if(name && phone) {
                document.getElementById('user-name').innerHTML = `${name}<br><small style="color:#777; font-weight:400;">${phone}</small>`;
                if(!document.getElementById('co-name').value) document.getElementById('co-name').value = name;
                if(!document.getElementById('co-phone').value) document.getElementById('co-phone').value = phone;
            } else {
                document.getElementById('user-name').innerText = "Guest User";
            }
        },

        checkDiscountEligibility: () => {
            const phone = localStorage.getItem('rp_user_phone');
            const btn = document.getElementById('btn-discount-feature');
            const status = document.getElementById('discount-status');
            
            if(!phone) {
                btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; return;
            }

            db.ref('orders').orderByChild('customerPhone').equalTo(phone).once('value', s => {
                let totalSpent = 0;
                if(s.exists()) {
                    s.forEach(o => { if(o.val().status === 'completed') totalSpent += parseFloat(o.val().price); });
                }
                
                if(totalSpent >= 5000) {
                    btn.style.opacity = '1'; btn.style.pointerEvents = 'auto';
                    btn.style.background = '#d4edda'; btn.style.border = '1px solid green';
                    status.innerHTML = '<b style="color:green">AVAILABLE</b>';
                } else {
                    btn.style.opacity = '0.6'; btn.style.pointerEvents = 'none';
                    btn.style.background = '#f9f9f9'; btn.style.border = 'none';
                    status.innerHTML = `(Spent: ৳${totalSpent}/5000)`;
                }
            });
        },

        startLuckyGame: () => {
            window.app.navTo('game-screen');
            // Reset grid
            for(let i=1; i<=9; i++) {
                document.getElementById(`box-${i}`).innerText = '?';
                document.getElementById(`box-${i}`).classList.remove('highlight');
            }
            document.getElementById('spin-btn').disabled = false;
            document.getElementById('spin-btn').innerText = "SPIN NOW";
        },

        openCampaign: () => {
            window.app.navTo('campaign-screen');
            const list = document.getElementById('campaign-list');
            list.innerHTML = '<div style="text-align:center;"><div class="spinner"></div></div>';

            db.ref('orders').once('value', snapshot => {
                const data = snapshot.val();
                if(!data) { list.innerHTML = '<p style="text-align:center;">No Data</p>'; return; }

                let userTotals = {};
                Object.values(data).forEach(o => {
                    if(o.status === 'completed') {
                        if(!userTotals[o.customerPhone]) userTotals[o.customerPhone] = { name: o.customerName || 'Unknown', phone: o.customerPhone, amount: 0 };
                        userTotals[o.customerPhone].amount += parseFloat(o.price);
                    }
                });

                let leaderboard = Object.values(userTotals).sort((a, b) => b.amount - a.amount);
                list.innerHTML = '';
                if(leaderboard.length === 0) { list.innerHTML = '<p style="text-align:center; margin-top:20px;">No completed orders.</p>'; return; }

                leaderboard.forEach((u, index) => {
                    let rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                    list.insertAdjacentHTML('beforeend', `
                    <div class="campaign-list-item ${rankClass}">
                        <div style="display:flex; align-items:center;">
                            <div class="rank-badge">${index + 1}</div>
                            <div>
                                <div style="font-weight:700; color:#333;">${u.name}</div>
                                <div style="font-size:0.8rem; color:#777;">${u.phone.substring(0,5)}***</div>
                            </div>
                        </div>
                        <div style="font-weight:700; color:var(--primary);">৳${u.amount}</div>
                    </div>`);
                });
            });
        },

        selectPayment: (method, el) => {
            document.querySelectorAll('.payment-option').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('co-payment').value = method;
            if(method === 'cod') {
                document.getElementById('trx-box').style.display = 'none';
                document.getElementById('co-trx').value = ''; 
            } else {
                document.getElementById('trx-box').style.display = 'block';
            }
        },

        fetchBanner: () => {
            db.ref('settings/banner').on('value', snapshot => {
                const data = snapshot.val();
                if(data) {
                    if(data.image) document.getElementById('banner-img').src = data.image;
                    if(data.title) document.getElementById('banner-title').innerHTML = data.title;
                    if(data.subtitle) document.getElementById('banner-sub').innerText = data.subtitle;
                }
            });
        },

        checkPromo: () => {
            db.ref('settings/promo').once('value', snapshot => {
                const data = snapshot.val();
                if(data && (data.image || data.text)) {
                    document.getElementById('promo-img').src = data.image || '';
                    document.getElementById('promo-img').style.display = data.image ? 'block' : 'none';
                    document.getElementById('promo-text').innerText = data.text || '';
                    document.getElementById('promo-text').style.display = data.text ? 'block' : 'none';
                    document.getElementById('promo-modal').style.display = 'flex';
                }
            });
        },

        fetchProducts: () => {
            db.ref('products').once('value', snapshot => {
                const data = snapshot.val();
                window.products = [];
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '';
                
                if(data) {
                    Object.keys(data).forEach(key => window.products.push({...data[key], id: key}));
                    window.products.reverse();
                    window.app.filterGender('all'); 
                    window.ds.renderDSGrid();
                    window.app.generateCategories();
                    window.app.generateSeasons();

                    const urlParams = new URLSearchParams(window.location.search);
                    const sharedPid = urlParams.get('pid');
                    if (sharedPid) {
                        const found = window.products.find(p => p.id === sharedPid);
                        if(found) {
                            document.getElementById('intro-overlay').style.display = 'none';
                            document.getElementById('main-app').style.opacity = '1';
                            document.body.style.overflow = 'auto';
                            window.app.openProduct(sharedPid);
                        }
                    }
                } else grid.innerHTML = '<p style="grid-column:span 2; text-align:center;">No Products Found</p>';
            });
        },

        filterGender: (type) => {
            window.activeGender = type;
            document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
            if(type === 'Men') document.getElementById('btn-gen-men').classList.add('active');
            else if(type === 'Women') document.getElementById('btn-gen-women').classList.add('active');
            else document.getElementById('btn-gen-all').classList.add('active');

            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            let filtered = type === 'all' ? window.products : window.products.filter(p => p.gender && p.gender.toLowerCase().includes(type.toLowerCase()));
            
            if(filtered.length > 0) filtered.forEach(p => window.app.renderCard(p, grid));
            else grid.innerHTML = '<p style="grid-column:span 2; text-align:center; padding:20px;">No products found</p>';
        },

        toggleSearchMode: (mode) => {
            const n=document.getElementById('btn-mode-name'), c=document.getElementById('btn-mode-cat'), s=document.getElementById('btn-mode-season');
            const cc=document.getElementById('category-container'), sc=document.getElementById('season-container'), ic=document.getElementById('search-input-container');
            const grid=document.getElementById('search-results'); grid.innerHTML='';
            n.classList.remove('active'); c.classList.remove('active'); s.classList.remove('active');

            if (mode === 'name') {
                n.classList.add('active'); cc.style.display = 'none'; sc.style.display = 'none'; ic.style.display = 'block';
                document.getElementById('search-input').placeholder = "নাম, ক্যাটাগরি বা কোড (ID) লিখুন...";
                window.products.forEach(p => window.app.renderCard(p, grid));
            } else if (mode === 'category') {
                c.classList.add('active'); cc.style.display = 'block'; sc.style.display = 'none'; ic.style.display = 'block';
                document.getElementById('search-input').placeholder = "ক্যাটাগরি খুঁজুন..."; 
                if(!document.getElementById('category-filters').innerHTML) window.app.generateCategories();
                grid.innerHTML = '<p style="text-align:center; width:200%; margin-top:20px; color:#888;">ক্যাটাগরি সিলেক্ট করুন</p>';
            } else if (mode === 'season') {
                s.classList.add('active'); cc.style.display = 'none'; sc.style.display = 'block'; ic.style.display = 'none';
                if(!document.getElementById('season-filters').innerHTML) window.app.generateSeasons();
                grid.innerHTML = '<p style="text-align:center; width:200%; margin-top:20px; color:#888;">সিজন সিলেক্ট করুন</p>';
            }
        },

        generateCategories: () => {
            const con = document.getElementById('category-filters');
            let tags = new Set(['All']);
            window.products.forEach(p => { if(p.category) p.category.split(',').forEach(t => tags.add(t.trim())); });
            con.innerHTML = '';
            tags.forEach(t => {
                const b = document.createElement('button'); b.className = 'cat-btn'; b.innerText = t;
                b.onclick = () => window.app.filterByCategory(t, b);
                con.appendChild(b);
            });
        },
        generateSeasons: () => {
            const con = document.getElementById('season-filters');
            let tags = new Set();
            window.products.forEach(p => { if(p.season) p.season.split(',').forEach(t => tags.add(t.trim())); });
            con.innerHTML = '';
            if(tags.size === 0) con.innerHTML = '<small>No seasons</small>';
            tags.forEach(t => {
                const b = document.createElement('button'); b.className = 'cat-btn'; b.innerText = t;
                b.onclick = () => window.app.filterBySeason(t, b);
                con.appendChild(b);
            });
        },

        filterByCategory: (tag, btn) => {
            document.querySelectorAll('#category-filters .cat-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            const grid = document.getElementById('search-results'); grid.innerHTML = '';
            const res = tag === 'All' ? window.products : window.products.filter(p => p.category && p.category.includes(tag));
            if(res.length) res.forEach(p => window.app.renderCard(p, grid));
            else grid.innerHTML = '<p style="text-align:center; width:100%;">No products</p>';
        },
        filterBySeason: (tag, btn) => {
            document.querySelectorAll('#season-filters .cat-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            const grid = document.getElementById('search-results'); grid.innerHTML = '';
            const res = window.products.filter(p => p.season && p.season.includes(tag));
            if(res.length) res.forEach(p => window.app.renderCard(p, grid));
            else grid.innerHTML = '<p style="text-align:center; width:100%;">No products</p>';
        },

        searchProduct: (q) => {
            const grid = document.getElementById('search-results'); grid.innerHTML = '';
            if(!q) { if(document.getElementById('btn-mode-name').classList.contains('active')) window.products.forEach(p => window.app.renderCard(p, grid)); return; }
            const term = q.toLowerCase();
            const res = window.products.filter(p => p.name.toLowerCase().includes(term) || (p.category && p.category.toLowerCase().includes(term)) || String(p.id).includes(term) || (p.code && String(p.code).includes(term)));
            if(res.length) res.forEach(p => window.app.renderCard(p, grid));
            else grid.innerHTML = '<p style="text-align:center; padding:20px;">No match found</p>';
        },

        renderCard: (p, container) => {
            let img = (p.media && p.media.length > 0) ? p.media[0] : (p.image || 'https://via.placeholder.com/300');
            let priceHtml = `<div class="p-price">৳${p.price}</div>`;
            let discountHtml = '';
            if(p.oldPrice && parseFloat(p.oldPrice) > parseFloat(p.price)) {
                let d = Math.round(((p.oldPrice - p.price)/p.oldPrice)*100);
                priceHtml = `<div class="p-price-row"><div class="p-price">৳${p.price}</div><div class="p-old-price">৳${p.oldPrice}</div></div>`;
                discountHtml = `<div class="discount-badge">-${d}%</div>`;
            }
            container.insertAdjacentHTML('beforeend', `
            <div class="product-card" onclick="window.app.openProduct('${p.id}')">
                ${discountHtml} ${p.gender ? `<div class="gender-tag-card">${p.gender}</div>` : ''}
                <div class="p-img-container"><img src="${img}"></div>
                <div class="p-details"><div class="p-name">${p.name}</div>${p.season ? `<div class="p-season"><i class="fas fa-snowflake"></i> ${p.season}</div>` : ''}${priceHtml}</div>
            </div>`);
        },

        openProduct: (id) => {
            const p = window.products.find(x => x.id === id);
            if(!p) return;
            window.currentProduct = p;
            
            const slider = document.getElementById('pd-slider'); slider.innerHTML = '';
            let media = (p.media && p.media.length) ? p.media : (p.image ? [p.image] : []);
            media.forEach(src => {
                const s = document.createElement('div'); s.className = 'media-slide';
                if(src.match(/\.(mp4|webm)$/)) s.innerHTML = `<video src="${src}" controls playsinline></video>`;
                else s.innerHTML = `<img src="${src}" onclick="window.app.openZoom(this.src)">`;
                slider.appendChild(s);
            });

            document.getElementById('pd-title').innerText = p.name;
            document.getElementById('pd-desc').innerText = p.description || '';
            document.getElementById('pd-season-tag').innerText = p.season ? `Season: ${p.season}` : '';
            document.getElementById('pd-gender-tag').innerText = p.gender || '';
            document.getElementById('pd-gender-tag').style.display = p.gender ? 'inline-block' : 'none';

            const elPrice = document.getElementById('pd-price');
            const elOld = document.getElementById('pd-old-price');
            const elTag = document.getElementById('pd-discount-tag');
            const elMsg = document.getElementById('lucky-msg');

            // --- DISCOUNT LOGIC ---
            let displayPrice = parseFloat(p.price);
            let originalDisplayPrice = parseFloat(p.oldPrice || p.price);
            
            elTag.style.display = 'none';
            elMsg.style.display = 'none';
            elOld.style.display = 'none';
            
            if(window.wonDiscountPercent > 0) {
                // Check if product is eligible (<= 3000)
                if(displayPrice <= 3000) {
                    let discountAmount = Math.round((displayPrice * window.wonDiscountPercent) / 100);
                    let finalP = displayPrice - discountAmount;
                    elPrice.innerText = '৳' + finalP;
                    elOld.innerText = '৳' + displayPrice;
                    elOld.style.display = 'block';
                    elMsg.innerText = `LUCKY WIN: ${window.wonDiscountPercent}% OFF APPLIED!`;
                    elMsg.style.display = 'block';
                    elMsg.style.color = '#28a745';
                } else {
                    elPrice.innerText = '৳' + displayPrice;
                    elMsg.innerText = "Discount not applicable (Max price 3000 TK)";
                    elMsg.style.display = 'block';
                    elMsg.style.color = 'red';
                }
            } else {
                if(p.oldPrice && parseFloat(p.oldPrice) > parseFloat(p.price)) {
                    elPrice.innerText = '৳' + p.price;
                    elOld.innerText = '৳' + p.oldPrice;
                    elOld.style.display = 'block';
                    elTag.innerText = `Save ৳${parseFloat(p.oldPrice) - parseFloat(p.price)}`;
                    elTag.style.display = 'inline-block';
                } else {
                    elPrice.innerText = '৳' + p.price;
                }
            }

            // Sizes & Colors
            const sC = document.getElementById('size-container'); sC.innerHTML = '';
            let rawS = p.sizes || p.size || ['Free Size'];
            if(typeof rawS === 'string') rawS = rawS.replace(/[\[\]"]/g,'').split(',').map(s=>s.trim()).filter(s=>s);
            if(!Array.isArray(rawS)) rawS = [rawS];
            rawS.forEach(s => {
                let btn = document.createElement('span'); btn.className = 'select-btn';
                btn.innerText = (typeof s==='object')?(s.name||s.value):s;
                btn.onclick = () => { document.querySelectorAll('#size-container .select-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); window.selectedSize=btn.innerText; };
                sC.appendChild(btn);
            });

            const cC = document.getElementById('color-container'); cC.innerHTML = '';
            let rawC = p.colors || p.color || ['Standard'];
            if(typeof rawC === 'string') rawC = rawC.split(',');
            rawC.forEach(c => {
                let btn = document.createElement('span'); btn.className = 'select-btn';
                btn.innerText = (typeof c==='object')?(c.name||c.color):c;
                btn.onclick = () => { document.querySelectorAll('#color-container .select-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); window.selectedColor=btn.innerText; };
                cC.appendChild(btn);
            });

            document.getElementById('btn-ds-add').style.display = window.isDropshippingMode ? 'block' : 'none';
            document.querySelector('.btn-main').style.display = window.isDropshippingMode ? 'none' : 'block';
            
            window.app.navTo('product-details-screen');
        },

        shareCurrentProduct: () => {
            if (!window.currentProduct) return;
            const url = `${window.location.href.split('?')[0]}?pid=${window.currentProduct.id}`;
            if (navigator.share) navigator.share({title: 'Royal Phantom', text: window.currentProduct.name, url: url}).catch(console.log);
            else { navigator.clipboard.writeText(url); alert("Link Copied!"); }
        },
        openZoom: (src) => { document.getElementById('zoom-img').src = src; document.getElementById('zoom-modal').style.display = 'flex'; },

        startCheckout: () => {
            if(!window.selectedSize || !window.selectedColor) return alert("Select Size & Color");
            window.app.checkUserSession();

            const pPrice = parseFloat(window.currentProduct.price);
            let finalPrice = pPrice;
            let msg = document.getElementById('discount-active-msg');
            let txt = document.getElementById('co-disc-txt');
            let hint = document.getElementById('pay-amount-hint');

            if(window.wonDiscountPercent > 0 && pPrice <= 3000) {
                let discAmt = Math.round((pPrice * window.wonDiscountPercent) / 100);
                finalPrice = pPrice - discAmt;
                msg.style.display = 'flex';
                txt.innerText = `LUCKY WIN: ${window.wonDiscountPercent}% Discount Applied!`;
            } else {
                msg.style.display = 'none';
            }
            
            hint.innerText = `Payable: ৳${finalPrice}`;
            window.app.navTo('checkout-screen');
        },

        showReview: () => {
            const name = document.getElementById('co-name').value, phone = document.getElementById('co-phone').value, addr = document.getElementById('co-address').value;
            const method = document.getElementById('co-payment').value, trx = document.getElementById('co-trx').value, ref = document.getElementById('co-ref').value;

            if(!name || !phone || !addr) return alert("Fill Name, Phone, Address");
            if(!method) return alert("Select Payment Method");
            if(method !== 'cod' && !trx) return alert("Enter Transaction ID");

            let pPrice = parseFloat(window.currentProduct.price);
            let finalPrice = pPrice;
            let note = "";
            let isDisc = false;

            if(window.wonDiscountPercent > 0 && pPrice <= 3000) {
                let discAmt = Math.round((pPrice * window.wonDiscountPercent) / 100);
                finalPrice = pPrice - discAmt;
                note = `(${window.wonDiscountPercent}% Lucky Discount)`;
                isDisc = true;
            }

            window.pendingOrder = {
                product: window.currentProduct.name, productId: window.currentProduct.id,
                price: finalPrice, originalPrice: window.currentProduct.price,
                size: window.selectedSize, color: window.selectedColor,
                customerName: name, customerPhone: phone, address: addr,
                paymentMethod: method, trxId: method === 'cod' ? 'COD' : trx,
                status: 'pending', date: new Date().toISOString(),
                refCodeUsed: ref, dropshipperPhone: window.isDropshippingMode ? localStorage.getItem('ds_phone') : null,
                isDropshipOrder: window.isDropshippingMode, isDiscounted: isDisc,
                adminNote: isDisc ? `LUCKY GAME WIN: ${window.wonDiscountPercent}%` : ""
            };

            document.getElementById('invoice-content').innerHTML = `
                <div class="inv-row"><span class="inv-label">Product:</span><span class="inv-val">${window.pendingOrder.product}</span></div>
                <div class="inv-row"><span class="inv-label">Size/Color:</span><span class="inv-val">${window.pendingOrder.size} / ${window.pendingOrder.color}</span></div>
                <div class="inv-row"><span class="inv-label">Price:</span><span class="inv-val">৳${window.pendingOrder.price} <small style="color:red">${note}</small></span></div>
                <div style="height:10px;"></div>
                <div class="inv-row"><span class="inv-label">Name:</span><span class="inv-val">${window.pendingOrder.customerName}</span></div>
                <div class="inv-row"><span class="inv-label">Phone:</span><span class="inv-val">${window.pendingOrder.customerPhone}</span></div>
                <div class="inv-row"><span class="inv-label">Address:</span><span class="inv-val">${window.pendingOrder.address}</span></div>
            `;
            window.app.navTo('review-screen');
        },

        finalizeOrder: () => {
            if(!window.pendingOrder) return alert("Expired");
            document.getElementById('loader').style.display = 'flex';
            
            const { customerPhone, customerName, address } = window.pendingOrder;
            localStorage.setItem('rp_user_phone', customerPhone);
            localStorage.setItem('rp_user_name', customerName);
            db.ref('users/'+customerPhone).update({ name: customerName, phone: customerPhone, address: address, lastOrder: Date.now() });

            db.ref('orders').push(window.pendingOrder).then(() => {
                document.getElementById('loader').style.display = 'none';
                window.app.playSuccessAnim(customerName);
                window.wonDiscountPercent = 0; // RESET DISCOUNT
                window.pendingOrder = null;
            }).catch(e => {
                document.getElementById('loader').style.display = 'none';
                alert("Error: " + e.message);
            });
        },

        playSuccessAnim: (name) => {
            const overlay = document.getElementById('success-overlay');
            document.getElementById('succ-user-name').innerHTML = '';
            name.split('').forEach(c => {
                const s = document.createElement('span'); s.innerText = c===' '?'\u00A0':c; s.className='brand-char';
                s.style.setProperty('--rx', (Math.random()*200-100)+'px');
                s.style.setProperty('--ry', (Math.random()*200-100)+'px');
                s.style.setProperty('--rr', (Math.random()*360-180)+'deg');
                s.style.animation = `assemble 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards 1s`;
                document.getElementById('succ-user-name').appendChild(s);
            });
            overlay.style.display = 'flex';
            document.getElementById('succ-msg-1').style.animation = 'fadeUp 1s ease forwards';
            setTimeout(() => {
                overlay.style.animation = 'curtainExit 0.8s ease forwards';
                setTimeout(() => { overlay.style.display='none'; overlay.style.animation=''; window.app.navTo('home-screen'); }, 800);
            }, 6000);
        },
        
        openOrders: () => {
            const p = localStorage.getItem('rp_user_phone');
            window.app.navTo('orders-screen');
            const l = document.getElementById('order-list-container');
            if(!p) { l.innerHTML = '<p style="text-align:center; margin-top:50px;">No history.</p>'; return; }
            l.innerHTML = '<div style="text-align:center;"><div class="spinner"></div></div>';
            db.ref('orders').orderByChild('customerPhone').equalTo(p).on('value', s => {
                l.innerHTML = '';
                if(s.exists()) {
                    Object.values(s.val()).reverse().forEach(o => {
                        let col = o.status==='pending'?'#f39c12':(o.status==='completed'?'green':'red');
                        l.insertAdjacentHTML('beforeend', `
                        <div style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; margin-bottom:5px; padding-bottom:5px;">
                                <span style="font-weight:700;">${o.product} ${o.isDiscounted?'<span style="color:red; font-size:0.7rem;">(LUCKY OFF)</span>':''}</span>
                                <span style="color:${col}; font-weight:600; text-transform:uppercase; font-size:0.8rem;">${o.status}</span>
                            </div>
                            <div style="font-size:0.9rem; color:#666;">
                                ৳${o.price} | ${o.size} | ${o.color}
                                <div style="font-size:0.7rem; color:#999; margin-top:5px; text-align:right;">${new Date(o.date).toLocaleDateString()}</div>
                            </div>
                        </div>`);
                    });
                } else l.innerHTML = '<p style="text-align:center;">No orders found.</p>';
            });
        }
    };

    // --- GAME LOGIC ---
    window.game = {
        spin: () => {
            const btn = document.getElementById('spin-btn');
            btn.disabled = true;
            btn.innerText = "SPINNING...";
            
            let spins = 0;
            const boxes = [1,2,3,4,5,6,7,8,9];
            const interval = setInterval(() => {
                // Clear highlight
                boxes.forEach(i => document.getElementById(`box-${i}`).classList.remove('highlight'));
                // Random highlight
                const r = Math.floor(Math.random() * 9) + 1;
                document.getElementById(`box-${r}`).classList.add('highlight');
                spins++;

                if(spins > 20) {
                    clearInterval(interval);
                    window.game.finishSpin();
                }
            }, 100);
        },
        finishSpin: () => {
            // Percentages mapped to boxes (You can change these)
            const rewards = [10, 20, 30, 40, 50, 60, 15, 25, 35];
            
            // Random Winner
            const winIndex = Math.floor(Math.random() * 9); // 0 to 8
            const winBoxId = winIndex + 1;
            const winPercent = rewards[winIndex];

            // Update UI
            for(let i=0; i<9; i++) {
                document.getElementById(`box-${i+1}`).innerText = rewards[i] + '%';
                document.getElementById(`box-${i+1}`).classList.remove('highlight');
            }
            document.getElementById(`box-${winBoxId}`).classList.add('highlight');

            // Save Result
            window.wonDiscountPercent = winPercent;

            setTimeout(() => {
                alert(`CONGRATULATIONS!\nYou won ${winPercent}% DISCOUNT!\n\nCondition: Apply on any product priced 3000 TK or less.`);
                window.app.navTo('home-screen');
                document.getElementById('spin-btn').innerText = "CLAIMED";
            }, 500);
        }
    };

    // --- DROPSHIPPING (Existing) ---
    window.ds = {
        checkAuth: () => { if(localStorage.getItem('ds_phone')) window.ds.loadDashboard(localStorage.getItem('ds_phone')); else window.app.navTo('ds-login-screen'); },
        register: () => {
            const p=document.getElementById('ds-reg-phone').value, pa=document.getElementById('ds-reg-pass').value, e=document.getElementById('ds-reg-email').value;
            if(!p || !pa) return alert("Fill all");
            db.ref('dropshippers/'+p).once('value', s => {
                if(s.exists()) alert("Exists");
                else {
                    db.ref('dropshippers/'+p).set({email:e, password:pa, phone:p, refCode:"RP-"+p.slice(-4), joinedAt:Date.now()});
                    alert("Registered!"); window.app.navTo('ds-login-screen');
                }
            });
        },
        login: () => {
            const p=document.getElementById('ds-login-phone').value, pa=document.getElementById('ds-login-pass').value;
            db.ref('dropshippers/'+p).once('value', s => {
                if(s.exists() && s.val().password === pa) { localStorage.setItem('ds_phone', p); window.ds.loadDashboard(p); }
                else alert("Invalid");
            });
        },
        logout: () => { localStorage.removeItem('ds_phone'); window.isDropshippingMode = false; window.app.navTo('profile-screen'); },
        loadDashboard: (p) => {
            window.app.navTo('ds-dashboard-screen');
            db.ref('dropshippers/'+p).once('value', s => {
                document.getElementById('ds-ref-code').innerText = s.val().refCode;
                db.ref('orders').orderByChild('dropshipperPhone').equalTo(p).once('value', os => {
                    let sales=0, amt=0;
                    if(os.exists()) { sales = Object.keys(os.val()).length; Object.values(os.val()).forEach(o => { if(o.status==='completed') amt+=parseFloat(o.price); }); }
                    window.currentDsBalance = amt*0.01;
                    document.getElementById('ds-sales').innerText = sales;
                    document.getElementById('ds-sold-amt').innerText = '৳'+amt;
                    document.getElementById('ds-balance').innerText = '৳'+window.currentDsBalance.toFixed(2);
                });
            });
            window.ds.renderDSGrid();
        },
        renderDSGrid: () => {
            const g = document.getElementById('ds-product-grid'); g.innerHTML = '';
            window.products.forEach(p => {
                let img = (p.media && p.media.length)?p.media[0]:(p.image||'');
                g.insertAdjacentHTML('beforeend', `<div class="product-card" onclick="window.ds.open('${p.id}')"><div class="p-img-container"><img src="${img}"></div><div class="p-details"><div class="p-name">${p.name}</div><div class="p-price">৳${p.price}</div></div></div>`);
            });
        },
        open: (id) => { window.isDropshippingMode = true; window.app.openProduct(id); },
        placeDropshipOrder: () => window.app.startCheckout(),
        copyRef: () => { navigator.clipboard.writeText(document.getElementById('ds-ref-code').innerText); alert("Copied"); },
        submitWithdraw: () => {
            const m=document.getElementById('w-method').value, n=document.getElementById('w-number').value, a=parseFloat(document.getElementById('w-amount').value);
            if(!n || !a || a<500 || a>window.currentDsBalance) return alert("Invalid Request");
            db.ref('withdrawals').push({dropshipperPhone:localStorage.getItem('ds_phone'), method:m, accountNumber:n, amount:a, status:'pending', date:new Date().toISOString()});
            alert("Submitted"); window.app.navTo('ds-dashboard-screen');
        }
    };

    function playIntro() {
        const b = document.getElementById('intro-brand'); b.innerHTML='';
        "The Royal Phantom".split('').forEach(c => {
            const s=document.createElement('span'); s.innerText=c===' '?'\u00A0':c; s.className='brand-char';
            s.style.setProperty('--rx', (Math.random()*200-100)+'px'); s.style.setProperty('--ry', (Math.random()*200-100)+'px'); s.style.setProperty('--rr', (Math.random()*360-180)+'deg');
            s.style.animation = `assemble 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards ${(Math.random()*0.5)+1.5}s`;
            b.appendChild(s);
        });
        document.getElementById('intro-welcome').style.animation='fadeUp 1s ease forwards';
        setTimeout(()=>{document.getElementById('intro-tagline').style.animation='expandLine 1.5s ease forwards'}, 3000);
        setTimeout(()=>{document.getElementById('intro-overlay').style.animation='curtainExit 1s ease forwards'; document.getElementById('main-app').style.opacity='1'; document.body.style.overflow='auto'; setTimeout(window.app.checkPromo, 1000);}, 5000);
    }

    window.onload = () => {
        if(!new URLSearchParams(window.location.search).get('pid')) playIntro();
        else document.getElementById('intro-overlay').style.display='none';
        window.app.fetchProducts(); window.app.fetchBanner(); window.app.checkUserSession();
    };
</script>
</body>
</html>
